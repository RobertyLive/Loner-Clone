ion}},{key:"updateCommentPosition",value:function updateCommentPosition(t,i){this.commentsPosition[t]=i}},{key:"getCommentPositionInsertIndex",value:function getCommentPositionInsertIndex(t){if(ei.shouldUseModernViewer){for(var i=-1,a=0;a<this.commentsPosition.length;a+=1){var A=this.commentsPosition[a];if(t.pageIndex<A.pageIndex&&-1===i)i=a;else if(t.pageIndex===A.pageIndex){if(!(t.nTop>=A.nTop)){i=a;break}i=a+1}}return-1===i&&(i=0===this.commentsPosition.length?0:this.commentsPosition.length),i}return this.commentsPosition.filter((function(i){var a=i.nTop+pt.getPageYOffset(i.pageIndex),A=t.nTop+pt.getPageYOffset(t.pageIndex);return t.pageIndex>i.pageIndex||a<A||(a===A||a-A<1)&&i.bbLeft<=t.bbLeft})).length}},{key:"getCommentIndex",value:function getCommentIndex(t){return this.commentsPosition.findIndex((function(i){return i.commentId===t}))}},{key:"resetCommentPopupAnimatedCount",value:function resetCommentPopupAnimatedCount(){this.commentPopupAnimatedCount=0}},{key:"resetCommentsPosition",value:function resetCommentsPosition(){for(var t in this.commentsPosition)t.resetCommentPositionCache()}},{key:"resetCommentsPositionCache",value:function resetCommentsPositionCache(){this.resetCommentsPosition(),this.resetCommentPopupAnimatedCount()}}]),CommentsPositionStore}(),ze=T()(He.prototype,"commentsPosition",[x.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),We=T()(He.prototype,"commentPopupAnimatedCount",[x.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),T()(He.prototype,"addCommentPosition",[x.action],Object.getOwnPropertyDescriptor(He.prototype,"addCommentPosition"),He.prototype),T()(He.prototype,"addViewrefToCommentPosition",[x.action],Object.getOwnPropertyDescriptor(He.prototype,"addViewrefToCommentPosition"),He.prototype),T()(He.prototype,"updateViewrefToCommentPosition",[x.action],Object.getOwnPropertyDescriptor(He.prototype,"updateViewrefToCommentPosition"),He.prototype),T()(He.prototype,"updateCommentPopupAnimatedCount",[x.action],Object.getOwnPropertyDescriptor(He.prototype,"updateCommentPopupAnimatedCount"),He.prototype),T()(He.prototype,"updateCommentPositionHeight",[x.action],Object.getOwnPropertyDescriptor(He.prototype,"updateCommentPositionHeight"),He.prototype),T()(He.prototype,"updateCommentPositionRTop",[x.action],Object.getOwnPropertyDescriptor(He.prototype,"updateCommentPositionRTop"),He.prototype),T()(He.prototype,"updateCommentPositionNTop",[x.action],Object.getOwnPropertyDescriptor(He.prototype,"updateCommentPositionNTop"),He.prototype),T()(He.prototype,"updateCommentPositionStatus",[x.action],Object.getOwnPropertyDescriptor(He.prototype,"updateCommentPositionStatus"),He.prototype),T()(He.prototype,"deleteCommentPosition",[x.action],Object.getOwnPropertyDescriptor(He.prototype,"deleteCommentPosition"),He.prototype),T()(He.prototype,"resetCommentPopupAnimatedCount",[x.action],Object.getOwnPropertyDescriptor(He.prototype,"resetCommentPopupAnimatedCount"),He.prototype),T()(He.prototype,"resetCommentsPosition",[x.action],Object.getOwnPropertyDescriptor(He.prototype,"resetCommentsPosition"),He.prototype),He),vt=function(){function CommentsPositionUtil(){var t=this;d()(this,CommentsPositionUtil),this.adjustedCommentTops=new Object,this.commentsPosition=Ct.commentsPosition,Object(x.reaction)((function(){return pt.viewRotation}),(function(){Ct.commentsPosition=Ct.commentsPosition.sort((function(t,i){var a=t.nTop+pt.getPageYOffset(t.pageIndex),A=i.nTop+pt.getPageYOffset(i.pageIndex);return i.pageIndex>t.pageIndex||a<A||(a===A||a-A<1)&&t.bbLeft<=i.bbLeft?-1:1})),t.commentsPosition=Ct.commentsPosition,t.commentsPosition.forEach((function(i){return t.alignComment(i.commentId)}))}))}return m()(CommentsPositionUtil,[{key:"animateCommentPopups",value:function animateCommentPopups(){for(var t in this.adjustedCommentTops){var i=this.getCommentIndex(t);if(-1!==i){var a=this.commentsPosition[i],A=this.adjustedCommentTops[t]-pt.getPageYOffset(a.pageIndex);a.rTop!==A&&Ct.updateCommentPositionRTop(a.commentId,A)}else delete this.adjustedCommentTops[t]}}},{key:"getMovingDistForUpperPopups",value:function getMovingDistForUpperPopups(t,i){if(t<=0||i<0)return 0;var a=this.commentsPosition[t],A=this.commentsPosition[i],l=this.adjustedCommentTops[a.commentId];return this.adjustedCommentTops[A.commentId]+A.height-l+20}},{key:"getMovingDistForDownPopups",value:function getMovingDistForDownPopups(t,i){var a=this.commentsPosition,A=a[t],l=this.commentsPosition[i],u=this.adjustedCommentTops[A.commentId],d=A.height,c=this.adjustedCommentTops[l.commentId];if(!(i>=a.length))return u+d-c+20}},{key:"setUpperCommentsPosition",value:function setUpperCommentsPosition(t){if(!(t<0)){var i=this.commentsPosition[t],a=i.commentId,A=pt.getPageYOffset(i.pageIndex),l=this.adjustedCommentTops[a],u=this.getMovingDistForUpperPopups(t+1,t);u>0?l=this.adjustedCommentTops[a]-u:u<0&&i.nTop+A>this.adjustedCommentTops[a]&&(l=Math.min(l-u,i.nTop+pt.getPageYOffset(i.pageIndex))),this.adjustedCommentTops[a]===l||u<2&&u>-2||(this.adjustedCommentTops[a]=l,this.setUpperCommentsPosition(t-1))}}},{key:"setDownCommentsPosition",value:function setDownCommentsPosition(t){var i=this.commentsPosition;if(!(t<0||t>=i.length)){var a=i[t],A=a.commentId,l=pt.getPageYOffset(a.pageIndex),u=this.adjustedCommentTops[A],d=this.getMovingDistForDownPopups(t-1,t);d>0?u=this.adjustedCommentTops[A]+d:d<0&&a.nTop+l<this.adjustedCommentTops[A]&&(u=Math.max(a.nTop+l,u+d)),this.adjustedCommentTops[A]===u||d<2&&d>-2||(this.adjustedCommentTops[A]=u,this.setDownCommentsPosition(t+1))}}},{key:"cascadeUpperPopups",value:function cascadeUpperPopups(t){0!==t&&this.setUpperCommentsPosition(t-1)}},{key:"cascadeDownPopups",value:function cascadeDownPopups(t){t===this.commentsPosition.length-1||t<0||this.setDownCommentsPosition(t+1)}},{key:"cascadeSurroundingCommentPopups",value:function cascadeSurroundingCommentPopups(t){this.cascadeUpperPopups(t),this.cascadeDownPopups(t)}},{key:"alignCommentWithText",value:function alignCommentWithText(t){var i=this.getCommentIndex(t),a=this.commentsPosition[i];a&&(this.adjustedCommentTops[a.commentId]=a.nTop+(pt.getPageYOffset(a.pageIndex)?pt.getPageYOffset(a.pageIndex):0),this.cascadeSurroundingCommentPopups(i),this.animateCommentPopups())}},{key:"alignCommentAtAdjustedPos",value:function alignCommentAtAdjustedPos(t){var i=this.getCommentIndex(t),a=this.commentsPosition[i];a&&(this.adjustedCommentTops[a.commentId]=a.nTop+(pt.getPageYOffset(a.pageIndex)?pt.getPageYOffset(a.pageIndex):0),i?(this.cascadeDownPopups(i-1,t),this.cascadeDownPopups(i,t)):this.cascadeDownPopups(i,t),this.animateCommentPopups())}},{key:"alignComment",value:function alignComment(t){t===$o.selectedCommentId?setTimeout((function(){CommentsPositionUtil.getInstance().alignCommentWithText(t)}),0):(CommentsPositionUtil.getInstance().alignCommentAtAdjustedPos(t),void 0!==$o.selectedCommentId&&setTimeout((function(){CommentsPositionUtil.getInstance().alignCommentWithText($o.selectedCommentId)}),0))}},{key:"bringTopCommentPopupsIntoView",value:function bringTopCommentPopupsIntoView(){if(this.commentsPosition.length>0){var t=this.commentsPosition[0];t.rTop<0&&this.alignCommentWithText(t.commentId)}}},{key:"getCommentIndex",value:function getCommentIndex(t){return this.commentsPosition.findIndex((function(i){return i.commentId===t}))}}],[{key:"getInstance",value:function getInstance(){return CommentsPositionUtil._instance||(CommentsPositionUtil._instance=new CommentsPositionUtil),CommentsPositionUtil._instance}}]),CommentsPositionUtil}();vt._instance=void 0;var bt,yt,_t,It,wt,Mt,kt,St,Tt,xt,Et,Pt,Nt,Rt,Dt,Ot,Lt,Bt,Ut,Ft,jt,Ht,zt,Wt,Vt,Yt,Kt,qt,Gt,Xt,Zt,Jt,Qt,$t,en,tn,nn,rn,an,sn,An,ln,un,dn,cn,mn,hn,pn,fn,gn,Cn,vn,bn,yn,_n,In,wn,Mn,kn,Sn,Tn,xn,En,Pn,Nn,Rn,Dn,On,Ln,Bn,Un,Fn,jn,Hn,zn,Wn,Vn,Yn,Kn,qn,Gn=Object.freeze({LOCAL:"local"}),Xn=Object.freeze({RHP:"RHP",MAIN_CONTENT_AREA:"MAIN_CONTENT_AREA"}),Zn=Object.freeze({TOOLTIP_RIGHT_PLACEMENT:"right",TOOLTIP_DELAY:1e3,TOOLTIP_HOVER:"hover"}),Jn=a("D1y2"),Qn=a.n(Jn),$n=function(){function CreateCommentCommand(t,i,a){var A=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};d()(this,CreateCommentCommand);var l=A.autoCommit,u=A.timeoutPeriod,c=A.shouldTakeFocus;this.commentBody=t,this.selector=t.target.selector,this.selectedCoordsObj=i,this.autoCommit=!!he()||l,this.userProfileStore=a.userProfileStore,this.reviewParticipantsStore=a.reviewParticipantsStore,this.toolBarStore=a.toolBarStore,this.commentsStore=a.commentsStore,this.commentsDropinStore=a.commentsDropinStore,this.pageIndex=this.selector.node.index,this.timeoutPeriod=u,this.comment=void 0,this.shouldTakeFocus=c,this.commentsUtil=Fi.getInstance()}return m()(CreateCommentCommand,[{key:"resetSelectedTool",value:function resetSelectedTool(){var t=this;this.selector.subtype!=L.REDHAWK_COMMENT_HIGHLIGHT&&this.selector.subtype!=L.REDHAWK_COMMENT_STRIKEOUT&&this.selector.subtype!=L.REDHAWK_COMMENT_UNDERLINE&&setTimeout((function(){t.commentsDropinStore.shouldUseModernViewer||t.toolBarStore.resetSelectedTool()}),this.timeoutPeriod)}},{key:"isStickySyncedOnServer",value:function isStickySyncedOnServer(t){return this.commentsUtil.isStickyComment(t)&&!t.syncPending&&t.syncedWithServer}},{key:"executeOnUi",value:function executeOnUi(){var t;if(this.commentBody.motivation)t=this.commentBody;else{var i,a={},A=this.userProfileStore.getUserProfile();(this.userProfileStore.hasAuth||Ti())&&(i=A.getEmail(),a={id:A.getUserId(),name:A.getUserName(),email:i,type:L.PERSON}),Ti()&&A.getPictureURL()&&(a.img=A.getPictureURL());var l=this.toolBarStore.getToolColor(this.selector.subtype),u=this.toolBarStore.getCurrentOpacity();this.selector.strokeColor=l,this.selector.opacity=u;var d=this.commentsUtil.getCurrentTimeStamp();t={bodyValue:this.commentBody.bodyValue||"",motivation:L.MOTIVATION_COMMENTING,target:{selector:this.selector},creator:a,created:d,modified:d}}var c={};void 0!==this.shouldTakeFocus&&(c.shouldTakeFocus=this.shouldTakeFocus);var m=this.commentsStore.addCommentsToPage(this.pageIndex,t,c);m.setSelectedCoords(this.selectedCoordsObj),!Ti()&&this.resetSelectedTool(),this.commentsStore.isSelectionInProgress=!1,this.commentsStore.addToUnsavedAnnotList(m.cid,m.motivation),m.setIsEditing(!1),this.comment=m}},{key:"executeOnServer",value:function executeOnServer(){this.commentsStore.saveCommentToServer(this.pageIndex,this.comment),this.comment.resetSyncPending(),this.comment.setSyncWithServer(!0),this.comment.id===this.commentsStore.selectedCommentId&&this.commentsStore.resetSelectedCommentId()}},{key:"execute",value:function execute(){var t=this;this.executeOnUi(),$o.setSelectedIndex(this.pageIndex);var i=this.commentsDropinStore.shouldUseModernViewer,a=this.commentsUtil.isStickyComment(this.comment),A=this.commentsUtil.isMarkupComment(this.comment);Ti()?(i?this.autoCommit?this.executeOnServer():it().then((function(i){i||(a?t.commentsDropinStore.setShouldShowCommentsPanel(!0):t.executeOnServer())})):this.autoCommit||!1===this.commentsDropinStore.forcedShouldShowCommentsPanel?(this.executeOnServer(),this.comment.bodyValue&&!we.isFreeText(this.comment)&&this.commentsDropinStore.setShouldShowCommentsPanel(!0)):i||this.commentsDropinStore.setShouldShowCommentsPanel(!0),oi("Commenting","CommentCreation","CommentAdded",{"adb.event.context.dc.parentAnnot":this.comment.target.selector.subtype,"adb.event.context.dc.pageNum":this.pageIndex})):i?i&&it().then((function(i){i||(a?(Di.apis.eventEmitter.emit("adobe:comments:commentsPanelOpen"),setTimeout((function(){t.commentsDropinStore.setShouldShowCommentsPanel(!0)}),0)):t.commentsStore.saveCommentToServer(t.pageIndex,t.comment))})):(a||A)&&(Di.apis.eventEmitter.emit("adobe:comments:commentsPanelOpen"),setTimeout((function(){t.commentsDropinStore.setShouldShowCommentsPanel(!0)}),0))}},{key:"undoOnUi",value:function undoOnUi(){this.commentsStore.deleteCommentFromPageUIModel(this.comment.cid,this.pageIndex),this.commentsStore.removeFromUnsavedAnnotList(this.comment.id,this.comment.motivation)}},{key:"undoOnServer",value:function undoOnServer(){this.commentsStore.deleteCommentFromServer(this.comment,this.pageIndex)}},{key:"undo",value:function undo(){Ti()&&(this.autoCommit||this.commentsUtil.isMarkupComment(this.comment)||this.isStickySyncedOnServer(this.comment))&&this.undoOnServer(),this.undoOnUi()}},{key:"redoOnUi",value:function redoOnUi(){var t=this.commentsUtil.getCurrentTimeStamp();this.comment.setModified(t),this.comment.setCreated(t),this.commentsStore.readdCommentsToPage(this.pageIndex,this.comment),!Ti()&&this.resetSelectedTool(),this.commentsStore.isSelectionInProgress=!1,this.commentsStore.addToUnsavedAnnotList(this.comment.cid,this.comment.motivation),this.comment.setIsEditing(!1),this.comment.resetUnsavedReplyBody(),this.comment.setIsReplying(!1)}},{key:"redoOnServer",value:function redoOnServer(){this.commentsStore.saveCommentToServer(this.pageIndex,this.comment),this.comment.resetSyncPending(),this.comment.setSyncWithServer(!0)}},{key:"redo",value:function redo(){this.redoOnUi(),Ti()&&(this.autoCommit||this.commentsUtil.isMarkupComment(this.comment)||this.isStickySyncedOnServer(this.comment))&&this.redoOnServer()}}]),CreateCommentCommand}(),eo=function(){function CreateReplyCommand(t,i,a,A){var l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};d()(this,CreateReplyCommand),this.comment=t,this.replyBody=i,this.pageIndex=a,this.newReply=void 0,this.stores=A,this.shouldTakeFocus=l.shouldTakeFocus,this.replyFailureCallback=l.replyFailureCallback}return m()(CreateReplyCommand,[{key:"executeOnUI",value:function executeOnUI(){var t;if(this.replyBody.content){var i=this.replyBody.mentions;t={bodyValue:this.replyBody.content||this.replyBody.bodyValue,target:{source:this.comment.sid},motivation:L.REPLYING,parent:this.comment,mentions:i}}else t=this.replyBody;var a=this.stores.commentsStore.getReplyUIModel(t,this.comment);"boolean"==typeof this.shouldTakeFocus&&a.setShouldTextTakeFocus(this.shouldTakeFocus),this.comment.addReply(a),this.newReply=a}},{key:"executeO